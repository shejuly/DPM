<!DOCTYPE html>
<html lang="cn_zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DaLeiBro Platform Manager</title>
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" media="screen" />
  <style rel="stylesheet">
    body{
      padding: 0;
      margin: 0;
      display: flex;
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      flex-flow: column nowrap;
      background: url("./bg.jpg");
      background-size: cover;
    }
    header.mainHeader{
      height: 100px;
      font-size: 48px;
      display: flex;
      justify-content: center;
      align-items: center;
      text-shadow: 2px 2px 2px rgba(0,0,0,0.5);
      color: #e6e6e6;
      overflow: hidden;
    }
    #container{
      flex: 1;
      padding: 0 50px;
      display: flex;
    }
    .page{
      flex: 1;
      display: flex;
    }
    .page2{
      display: none;
    }
    nav{
      flex: 4;
      margin-right: 20px;
      display: flex;
      flex-flow: column nowrap;
    }
    nav input.searchInput{
      background: rgba(255,255,255,0.8);
      height: 50px;
      line-height: 50px;
      color: #333;
      border: none;
      padding-left: 16px;
      border-radius: 2px;
      margin-bottom: 10px;
      outline: none;
    }
    nav ul.siteList, .page2 section .listPlace{
      flex: 1;
      background: rgba(255,255,255,0.8);
      margin: 0;
      padding: 4px 0;
      border-radius: 2px;
      display: flex;
      flex-flow: column nowrap;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      overflow: auto;
    }
    nav ul.siteList li.siteItem, .page2 section .listPlace li.siteItem{
      flex: 0 0 36px;
      align-items: center;
      background: none;
      list-style: none;
      color: #333;
      font-size: 14px;
      padding-left: 16px;
      display: flex;
    }
    nav ul.siteList li.siteItem:hover, .page2 section .listPlace li.siteItem:hover{
      background: rgba(0,0,0,0.1);
    }
    nav ul.siteList li.siteItem.active, .page2 section .listPlace li.siteItem.active{
      background: rgba(0,0,0,0.1);
    }
    nav ul.siteList li.siteItem span.content, .page2 section .listPlace li.siteItem span.content{
      flex: 1;
    }
    .page2 section .listPlace li.siteItem span.content{
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .page2 section .listPlace li.siteItem span.content span{
      flex: 1;
      text-align: center;
      min-width: 1px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .page2 section .listPlaceHeader{
      display: flex;
      padding: 5px;
      text-align: center;
    }
    .page2 section .listPlaceHeader span{
      flex: 1;
    }
    nav ul.siteList li.siteItem a.arrow{
      width: 50px;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      text-decoration: none;
    }
    nav ul.siteList li.siteItem a.arrow:hover{
      color: #4998ca;
      background: rgba(255,255,255,0.2);
    }
    .searchInput::-webkit-input-placeholder {
      color:#aaa;
    }
    section{
      flex: 10;
      background: rgba(255,255,255,0.8);
      border-radius: 2px;
      display: flex;
      flex-flow: column nowrap;
      justify-content: center;
      align-items: center;
    }
    section input.blackInput{
      max-width: 300px;
      width: 80%;
      height: 40px;
      line-height: 40px;
      background: rgba(0,0,0,0.9);
      color: #fff;
      border: none;
      font-size: 20px;
      padding: 0 12px;
      outline:none;
      margin-bottom:20px;
    }
    section .info1{
      font-size: 14px;
      line-height: 40px;
      text-align: center;
      justify-content: center;
      align-items: center;
      flex-flow: column nowrap;
      display: none;
    }
    section .info1 .selectPsw.active{
      border: 1px dashed darkblue;
    }
    section .info2{
      font-size: 14px;
      line-height: 30px;
      text-align: left;
      display: none;
    }
    section .info2 .soonLine{
      display: none;
    }
    footer.mainFooter{
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .switcher{
      width: 70px;
      height: 15px;
      display: flex;
    }
    .switchItem{
      background: #fff;
      border-radius: 2px;
      box-shadow: 0 2px 4px rgba(33,33,33,0.26);
      flex: 1;
      transition:flex 0.25s ease-out;
    }
    .switchItem.active{
      flex: 2;
    }
    .switchItem:not(.active){
      cursor: pointer;
    }
    .switchItem:first-child{
      margin-right: 10px;
    }
    .page1 .row1,.page1 .row2,.page1 .row3{
      flex: 1;
    }
    .page1 .row1{
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .page2 nav{
      background: rgba(255,255,255,0.8);
      padding: 10px;
    }
    .page2 nav.leftBar .inputLine {
      height: 50px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
    }
    .page2 nav.leftBar .inputLine .leftText{
      width: 70px;
      font-size: 14px;
    }
    .page2 nav.leftBar .inputLine .rightInput{
      flex: 1;
      border: none;
      padding-left: 12px;
      background: #000;
      color: #f5f5f5;
      line-height: 30px;
    }
    .page2 nav.leftBar .btn{
      display: flex;
      justify-content: center;
      align-items: center;
      background: #4998ca;
      padding: 8px;
      color: #fff;
      margin-top: 10px;
      cursor: pointer;
    }
    .page2 section{
      display: flex;
      padding: 0 20px 20px;
      flex-flow: column nowrap;
      justify-content: flex-start;
      align-items: stretch;
    }
    .page2 section .listPlace {
      flex: 10;
    }
    #copyBtn {
      background: #4998ca;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      line-height: 40px;
      -webkit-border-radius: 3px;
      -moz-border-radius: 3px;
      border-radius: 3px;
      width: 80px;
      cursor: pointer;
    }
    @media screen and (max-width:720px) {
      header.mainHeader{
        font-size: 24px;
        height: 50px;
      }
      #container{
        padding: 0 20px;
      }
    }
    @media screen and (max-width:500px){
      /*body{*/
        /*display: block;*/
      /*}*/
      header.mainHeader{
        font-size: 20px;
        height: 50px;
      }
      #container{
        padding: 0 10px;
      }
      .page{
        flex-flow: column nowrap;
      }
      .page1 nav{
        margin-right: 0;
        margin-bottom: 10px;
        min-height: 300px;
        flex: 10;
      }
      .page2 nav{
        margin-right: 0;
        margin-bottom: 10px;
        min-height: 185px;
        flex: 4;
      }
      nav ul.siteList {
        overflow: auto;
      }
      .page1 section{
        min-height: 185px;
        flex: 4;
      }
      .page2 section{
        min-height: 400px;
        flex: 10;
        overflow: auto;
      }
    }
    @keyframes changeColor {
      0%     { background: #4998ca; }
      50%    { background: #ca5142; }
      100%   { background: #4998ca; }
    }
    .changeColor {
      -webkit-animation-duration: 0.4s;
      animation-duration: 0.4s;
      -webkit-animation-name: changeColor;
      animation-name: changeColor;
    }
  </style>
</head>
<body>
<header class="mainHeader">DaLeiBro Platform Manager</header>
<div id="container">
  <div class="page page1">
    <nav class="leftBar">
      <input class="searchInput" type="text" placeholder="网站名称">
      <ul class="siteList">
      </ul>
    </nav>
    <section>
      <div class="row1">
        <input class="blackInput command" type="password">
      </div>
      <div class="row2">
        <div class="info1">
          <div class="realPassWord">
            <span class="selectPsw active">
              短：<span class="pswText_short">*******</span>
            </span>
            <span class="selectPsw">
              长：<span class="pswText_long">*******</span>
            </span>
            <span class="selectPsw">
              超长：<span class="pswText_tooLong">*******</span>
            </span>
            <span class="selectPsw">
              数字：<span class="pswText_num">*******</span>
            </span>
          </div>
          <btn class="copyBtn" id="copyBtn">复制</btn>
        </div>
      </div>
      <div class="row3">
        <div class="info2">
          <div class="userName">
            用户名：
          </div>
          <div class="soonLine">
            请使用<span class="soonName"></span>登录
          </div>
        </div>
      </div>
    </section>
  </div>
  <div class="page page2">
    <nav class="leftBar">
      <div class="inputLine">
        <span class="leftText">唯一名称</span>
        <input class="rightInput idName" type="text" placeholder="必填">
      </div>
      <div class="inputLine">
        <span class="leftText">网站地址</span>
        <input class="rightInput href" type="text" placeholder="选填">
      </div>
      <div class="inputLine">
        <span class="leftText">指向平台</span>
        <input class="rightInput toSoon" type="text" placeholder="选填，值为1 QQ，2 微信，3, 微博">
      </div>
      <div class="inputLine">
        <span class="leftText">账号</span>
        <input class="rightInput userName" type="text" placeholder="必填">
      </div>
      <div class="btn addOneBtn">
        确定
      </div>
    </nav>
    <section>
      <div class="listPlaceHeader">
        <span>唯一名称</span>
        <span>账号</span>
        <span>网站地址</span>
        <span>指向平台</span>
      </div>
      <ul class="listPlace">
      </ul>
    </section>
  </div>
</div>
<footer class="mainFooter">
  <div class="switcher">
    <div class="switchItem active"></div>
    <div class="switchItem"></div>
  </div>
</footer>
<script src="./jquery-3.3.1.min.js"></script>
<script src="md5.js" type="text/javascript"></script>
<script src="./clipboard.min.js"></script>
<script>
//  var jquery1 = require('jquery');
//  console.log(jquery);
  if (!localStorage.mainArr) {
    localStorage.mainArr = '[]';
  }
  var mainArr = JSON.parse(localStorage.mainArr);
  var nowId;
  // 第二页当前选中的id。
  var page2CurrentItemId;
      /*[
    {
      idName: '支付宝',
      userName:'nuojuly@163.com',
      href: 'https://www.alipay.com/',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    },
    {
      idName: '微信',
      userName:'shejuly / 15011032800',
      href: '',
      toSoon: ''
    }
  ]*/
  var $SearchInput = $('.searchInput');
  var $listUl = $('.siteList');
  var $listUl2 = $('.listPlace');
  var $commandInput = $('.command');
  var $info1 = $('.info1');
  var $info2 = $('.info2');
  var $switchBar = $('.switcher');
  var $page1 = $('.page1');
  var $page2 = $('.page2');
  var $list2 = $page2.find('.leftBar');
  var $copyBtn = $('#copyBtn');

  var getCurrentPassWord = function () {
    if (!nowId) {
      return '';
    }
    if (!$commandInput.val()) {
      return '';
    }
    return getPsw(nowId, $commandInput.val());
  };
  var getObjById = function (id) {
    return mainArr.find(function(e) {
      return e.idName === id
    });
  };
  var deleteById = function (id) {
    mainArr.splice($.inArray(id, mainArr), 1);
  };
  var getSoon = (num) => {
    var num = num - 0;
    if (num) {
      if (num === 1) {
        return 'QQ';
      } else if (num === 2) {
        return '微信';
      } else if (num === 3) {
        return '微博';
      } else {
        return '未知soon';
      }
    } else {
      return '';
    }
  };
  var getLiById = function (id, $ul) {
    return $ul.find('.siteItem[data-id=' + id + ']');
  };
  // 缓冲器 （防止短时间多次发送同一请求）
  var buffer = function (func, time) {
    var self = this;
    if (typeof func !== 'function') {
      return;
    }
    if (typeof time !== 'number') {
      return;
    }
    if (self._commonBufferTimer) clearTimeout(self._commonBufferTimer);
    self._commonBufferTimer = setTimeout(function () {
      func.call(self);
      self._commonBufferTimer = null;
    }, time);
  };
  var clearPswText = function () {
    $('.pswText_short').text('*******');
    $('.pswText_long').text('*******');
    $('.pswText_tooLong').text('*******');
    $('.pswText_num').text('*******');
  };
  class ListView {
    constructor () {
      this.$el = $listUl;
      this.$el2 = $listUl2;
      this.init();
      this.renderList();
      this.setEvent();
    }
    init () {
      // 复制用的对象
      new ClipboardJS('#copyBtn');
    }
    setEvent () {
      // 输入口令显示密码
      var showPsw = function () {
        var val = $commandInput.val();
        if (!nowId) {
          alert('请选中一个平台');
          return;
        }
        if (val) {
          const pswObj = getPsw(nowId, val);
          $copyBtn.attr('data-clipboard-text', pswObj.short);
          clearPswText();
//          $('.pswText_short').click();
          $info1.show().css('transition', 'transform 0.2s').css('transform', 'scale(1.2)').css('display', 'flex');
          setTimeout(function () {
            $info1.css('transform', 'scale(1)');
          }, 200);
        } else {
          $copyBtn.attr('data-clipboard-text', '');
          $info1.hide();
        }
      };
      $commandInput.on('keydown', function () {
        buffer(function () {
          showPsw();
        }, 500);
      });
      // 点击复制按钮，复制按钮变色
      $copyBtn.on('click', function() {
        $copyBtn.addClass('changeColor');
        setTimeout(function () {
          $copyBtn.removeClass('changeColor');
        }, 1000);
      });
      // 点击某种密码，切换选中状态
      $('.selectPsw').on('click', function (e) {
        $('.selectPsw').removeClass('active');
        $(e.currentTarget).addClass('active');
      });
      // 点击密码***，显示为真密码
      $('.pswText').on('click', function () {
        var pswObj = getCurrentPassWord();
        $('.pswText').text()
      })
    }
    setListEvent() {
      var self = this;
      // 第一页，点击某个列表项，右侧显示其内容。
      this.$el.find('li.siteItem').on('click', function (e) {
        var idName = $(e.currentTarget).find('.content').text();
        var obj = getObjById(idName);
        var $userName = $info2.find('.userName');
        var $soonLine = $info2.find('.soonLine');
        nowId = idName;
        if (obj.userName) {
          $userName.html('用户名:' + obj.userName).show();
        } else {
          $userName.hide();
        }
        $info1.hide();
        $info2.show();
        if (obj.toSoon) {
          $soonLine.find('.soonName').html(getSoon(obj.toSoon));
          $soonLine.show();
        } else {
          $soonLine.find('.soonName').html('');
          $soonLine.hide();
        }
        self.$el.find('li.siteItem').removeClass('active');
        $(e.currentTarget).addClass('active');
        $commandInput.val('').focus();
        $copyBtn.attr('data-clipboard-text', '');
      });
      // 第二页，点击某个列表项，左侧被填入。
      this.$el2.find('li.siteItem').on('click', function (e) {
        var idName = $(e.currentTarget).find('.content span.idName').text();
        var obj = getObjById(idName);
        $list2.find('.idName').val(idName);
        $list2.find('.userName').val(obj.userName);
        $list2.find('.href').val(obj.href);
        $list2.find('.toSoon').val(obj.toSoon);
        self.$el2.find('li.siteItem').removeClass('active');
        $(e.currentTarget).addClass('active');
        page2CurrentItemId = idName;
      });
    }
    renderList () {
      var lis = '';
      var lis2 = '';
      mainArr.forEach((e) => {
        lis  += '<li class="siteItem" data-id="' + e.idName + '"><span class="content">' + e.idName + '</span><a href="' + e.href + '" target = "_blank" class="arrow">></a></li>';
        lis2 += '<li class="siteItem" data-id="' + e.idName + '"><span class="content"><span class="idName">' + e.idName + '</span><span class="userName">' + e.userName + '</span><span class="href">' + e.href + '</span><span class="toSoon">' + getSoon(e.toSoon) + '</span></li>';
      });
      this.$el.html(lis);
      this.$el2.html(lis2);
      this.setListEvent();
      if (this.$el.find('li.siteItem') && this.$el.find('li.siteItem').length) {
        this.$el.find('li.siteItem').eq(0).click();
      }
    }
  }
  var listView = new ListView();
  var selectOneItem = function (type) {
    var selectFirst = function ($ul) {
      if ($ul.find('li.siteItem') && $ul.find('li.siteItem').length) {
        $ul.find('li.siteItem').eq(0).click();
      }
    };
    var selectLast = function ($ul) {
      if ($ul.find('li.siteItem') && $ul.find('li.siteItem').length) {
        $ul.find('li.siteItem').eq($ul.find('li.siteItem').length - 1).click();
      }
    };
    var selectCurrent = function ($ul) {
      var li = getLiById(page2CurrentItemId, $ul);
      if (li && li.length) {
        li.click();
      }
    };
    switch (type) {
      case 'first':
        selectFirst($listUl);
        selectFirst($listUl2);
        break;
      case 'current':
        selectCurrent($listUl);
        selectCurrent($listUl2);
        break;
      case 'last':
        selectLast($listUl);
        selectLast($listUl2);
        break;
      default:
        break;
    }
  };
  var fresh = function (type) {
    localStorage.mainArr = JSON.stringify(mainArr);
    listView.renderList();
    if (type === 'add') {
      selectOneItem('last');
    } else if (type === 'update') {
      selectOneItem('current');
    } else if (type === 'delete') {
      selectOneItem('first');
    }
  };
  var getPsw = function (nameId, userCommand) {
    var getMixStr = function (str1, str2) {
      var s1 = str1.substr(0, str1.length/2);
      var s2 = str1.substr(str1.length/2);
      var s3 = str2.substr(0, str2.length/2);
      var s4 = str2.substr(str2.length/2);
      return $.md5(s1+s3+s2+s4);
    };
// 加入特殊符号。
// 特殊符号会在最终密码的第2位到第7位之间出现1个。
    var getSpecialPsw = function (str) {
      // stormTodo 待删除
      console.log('str : %o', str);
      var specialList = ['*','!','$','#','(','^',')','@','&','%','+','=','[','|',';','{','<','?','>','}',',',']','/','.'];
      var indexWord = str[2];
      var insertIndex = indexWord.codePointAt(0) % 6;
      var insertWord = str[insertIndex];
      var specialIndex = insertWord.codePointAt(0) % 24;
      var specialWord = specialList[specialIndex];
      return str.substr(0, insertIndex) + specialWord + str.substr(insertIndex + 1);
    }
    var psw1 = $.md5(nameId);
    var psw2 = $.md5(userCommand);
    var pswMix = getMixStr(psw1, psw2);
    var pswSpecial = getSpecialPsw(pswMix);
    const psw_mix = psw2[0] + pswMix;
    const psw_special = psw2[0] + pswSpecial;
    return {
      short: psw_special.substr(0, 7),
      long: psw_special.substr(0, 10),
      soLong: psw_special.substr(0, 14),
      shortNum: psw_mix.substr(0, 7),
    };
  };
  $('.addOneBtn').on('click', function () {
    var obj = {
      idName: $('.page2 .leftBar .idName').val(),
      userName: $('.page2 .leftBar .userName').val(),
      href: $('.page2 .leftBar .href').val(),
      toSoon: $('.page2 .leftBar .toSoon').val()
    };
    var thatObj = getObjById(obj.idName);
    var type = '';
    if (thatObj) {
      // 删除
      if (!obj.userName && !obj.toSoon) {
        deleteById(obj.idName);
        type = 'delete';
      } else {
        // 修改
        thatObj.userName = obj.userName;
        thatObj.href = obj.href;
        thatObj.toSoon = obj.toSoon;
        type = 'update';
      }
    } else {
      // 添加失败
      if (!obj.idName) {
        alert('需要唯一id');
        return;
      }
      // 添加失败
      if (!obj.userName && !obj.toSoon) {
        alert('需要用户名 或者 快速登录');
        return;
      }
      // 添加
      mainArr[mainArr.length] = obj;
      type = 'add';
    }
    fresh(type);
  });
/*  $('.go').on('click', () => {
    var val = $('input').val();
    var valArr = val.split('');
    var constVal = 'qwert';
    var constArr = constVal.split('');
    valArr.forEach((e, i) => {
      console.log(e);
      console.log(i);
      constArr.splice(i+2, 0, e);
    });
    var result = constArr.join('');
    $('.outPut').html(hex_md5(result));
  });*/
  $switchBar.find('.switchItem').on('click', (e) => {
    var target = $(e.currentTarget);
    if (!target.hasClass('active')) {
      target.siblings().removeClass('active');
      target.addClass('active');
      if (target.index()) {
        $page1.slideUp(250, () => {
          $page2.slideDown(250).css('display', 'flex');
        });
      } else {
        $page2.slideUp(250, () => {
          $page1.slideDown(250).css('display', 'flex');
        });
      }
    }
  });
</script>
</body>
</html>